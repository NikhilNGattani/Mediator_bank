<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view1">
	<template>
		<style include="shared-styles">
		</style>

	 	<iron-ajax id="generateAgentRequest" method='GET' handle-as="json" content-type="application/json" on-response="handleResponse" on-error="handleError"></iron-ajax>
		 
		 <h3>
		 You have given permision to following agents :-
		 </h3>
		 <template is ="dom-repeat" items="{{agentsList}}">
			 <div>
				<span>{{_getIndex(index)}}.</span>
				&nbsp;
				<span>{{item.agentName}}</span>
			 </div>
		 </template>
		 <paper-button on-tap="generateReport">
                Generate transactions summary 
         </paper-button>
	</template>

	<script>
		Polymer({
			is: 'my-view1',
			properties: {
				loggedin:{
					type:Boolean,
          			reflectToAttribute: true,
					observer:'_loginChanged'
				},
				agentsList:{
					type:Array,
					notify:true
				}
			},
			_loginChanged: function () {
				if(this.loggedin){
					this.$$("#generateAgentRequest").url = "/api/Agents";
          			this.$$("#generateAgentRequest").generateRequest();
				}
			},
			handleResponse: function(e){
				this.agentsList = e.detail.response;
				var self = this;
				for(var i=0;i<this.agentsList.length;i++){
					var ajax = document.getElementById("iron-ajax");
					ajax.method = "GET";
					ajax.contentType = "application/json";
      				ajax.handleAs = "json";
					ajax.url = this.agentsList[i].agentAPI;
					ajax.headers["username"] = sessionStorage.userId;
					ajax.addEventListener("error", function(e){
						self.agentsList[i].response = "error";
					});
					ajax.addEventListener("response", function(e){
						self.agentsList[i].response = e.detail.response;
					});
					ajax.generateRequest();
				}
			},
			handleError : function(e){
				alert("Not able to fetch your registered agents");
			},
			_getIndex : function(index){
				return index+1;
			}
		});
	</script>
</dom-module>